// Copyright (c) 2010 - 2017 Mickael Riga - See MIT_LICENCE for details
// Version 2
function clear_canvas(context){context.clearRect(0,0,context.canvas.width,context.canvas.height);var w=context.canvas.width;context.canvas.width=1;context.canvas.width=w};(function($){$.fn.mapolygon=function(callback){return this.each(function(){var $$=$(this);var wrapper=$$.wrap("<div class='mapolygon_wrapper' />").parent().css({position:'relative'});var canvas=$("<canvas />").css({position:'absolute',left:'0px',top:'0px',cursor:'crosshair'}).bind('adapt.mapolygon',function(){$(this).attr('width',$$.width()).attr('height',$$.height())});wrapper.append(canvas);canvas.trigger('adapt.mapolygon');if(canvas.get(0).getContext){var ctx=canvas.get(0).getContext('2d')}$$.data().dots=[];$$.bind("show.mapolygon",function(e,dots){if(ctx){canvas.trigger('adapt.mapolygon');clear_canvas(ctx);ctx.fillStyle="rgba(0,0,255,0.5)";ctx.strokeStyle="rgba(0,0,255,0.5)";if(dots.length==2){ctx.fillRect((dots[0]*$$.width())-1,(dots[1]*$$.height())-1,3,3)}else{ctx.beginPath();for(i=0;i<dots.length;i+=2){ctx.lineTo(dots[i]*$$.width(),dots[i+1]*$$.height())}}ctx.fill();ctx.stroke()}else{for(i=0;i<dots.length;i+=2){$('.mapolygon',wrapper).remove();var dot=$("<div class='mapolygon_dot' />").css({position:'absolute',width:'1px',height:'1px',left:dots[i]*$$.width()+'px',top:dots[i+1]*$$.height()+'px',border:'2px solid blue',backgroundColor:'white'});wrapper.append(dot)}}});$$.bind("reset.mapolygon",function(){$$.data().dots=[];clear_canvas(ctx);$('.mapolygon',wrapper).remove()});$$.bind("enable.mapolygon",function(){$$.data().active=true});$$.bind("disable.mapolygon",function(){$$.data().active=false;$$.trigger('reset.mapolygon')});canvas.click(function(e){if($$.data().active){var pX=(e.pageX-$$.offset().left)/$$.width();var pY=(e.pageY-$$.offset().top)/$$.height();$$.data().dots.push(pX,pY);$$.trigger("show.mapolygon",[$$.data().dots]);if(callback){callback($$.data().dots,this)}}return false});$$.trigger('enable.mapolygon');$(window).resize(function(){$$.trigger("show.mapolygon",[$$.data().dots])})})}})(jQuery);
